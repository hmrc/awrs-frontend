@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.twirl.api.Html
@import uk.gov.hmrc.play.views.html._
@import uk.gov.hmrc.play.views.html.helpers._
@import views.html.helpers._
@import views.helpers._
@import java.text.DateFormatSymbols
@import utils.AccountUtils
@import views.Configuration._
@import views.view_application.helpers._
@import views.view_application.helpers.SubViewTemplateHelper._
@import services.DataCacheKeys._
@import utils.AwrsFieldConfig
@import uk.gov.hmrc.auth.core.Enrolment

@(businessType: Option[String], businessName: String, businessDetailsForm: Form[models.ExtendedBusinessDetails],
renderMode: views.Configuration.NewBusinessStartDateConfiguration, enrolments: Set[Enrolment])(implicit request: Request[AnyContent], viewApplicationType: ViewApplicationType = LinearViewMode, messages: Messages)

@implicitFormInstance = @{ Some(businessDetailsForm) }


@actionRoute = @{
    isEditMode match {
        case true => controllers.routes.BusinessDetailsController.saveAndReturn
        case false => controllers.routes.BusinessDetailsController.saveAndContinue
    }
}

@ctaMessage = @{
    isEditMode match {
        case true => Messages("awrs.generic.save_return")
        case false => Messages("awrs.generic.save_continue")
    }
}


@newBusinessSectionHeader = {
    <h2 class="heading-medium">@Messages("awrs.business_details.newBusiness")</h2>
}
@hiddenNewBusinessQuestion = {
    <input type="hidden" name="newAWBusiness.newAWBusiness" value="@{businessDetailsForm("newAWBusiness.newAWBusiness").value.getOrElse("No")}">
}

@newBusinessNewApplicationSection = {
    <div class="form-group">
        @awrsInputTypeRadioGroup(
            InputTypeRadioGroupParams(
                businessDetailsForm("newAWBusiness.newAWBusiness"),
                Seq("Yes" -> Messages("awrs.generic.yes"),
                    "No" -> Messages("awrs.generic.no")),
                fieldSetClass = "inline",
                fieldSetAttributes = "id=newAWBusiness.newAWBusiness_field",
                legendId = "newAWBusiness-legend",
                legend = Messages("awrs.business_details.new_AWBusiness"),
                ariaDescribedBy = "newAWBusiness-legend newAWBusiness.proposedStartDate-legend newBus-information-para",
                ariaDescribedByForYesOptionOnly = true
            )
        )
        <div id="newAWBusiness.newAWBusiness-yes-content">
            @awrsDateField(
                DateHelperParams(
                    formItem = businessDetailsForm,
                    fieldName = "newAWBusiness.proposedStartDate",
                    label = Some(Html(Messages("awrs.business_details.begin_trading"))),
                    hintText = Some(awrsNewBusinessHelpTextHelper()),
                    hintTextId  = "newBus-information",
                    ariaDayMonthYear = ariaDayMonthYear,
                    wrapperClass = "panel-indent",
                    ariaLabelledBy = "newAWBusiness.proposedStartDate-legend"
                )
            )
        </div>
    </div>
}

@newBusinessRetrievedApplicationSectionForNormalScenarios = {
    @hiddenNewBusinessQuestion
    <input type="hidden" name="newAWBusiness.proposedStartDate.day" value="@{businessDetailsForm("newAWBusiness.proposedStartDate.day").value}">
    <input type="hidden" name="newAWBusiness.proposedStartDate.month" value="@{businessDetailsForm("newAWBusiness.proposedStartDate.month").value}">
    <input type="hidden" name="newAWBusiness.proposedStartDate.year" value="@{businessDetailsForm("newAWBusiness.proposedStartDate.year").value}">
    <div id="notNewBusiness">
    @{
        businessDetailsForm("newAWBusiness.newAWBusiness").value match {
            case Some("Yes") =>
                val day = businessDetailsForm("newAWBusiness.proposedStartDate.day").value.get
                val month = businessDetailsForm("newAWBusiness.proposedStartDate.month").value.get
                val year = businessDetailsForm("newAWBusiness.proposedStartDate.year").value.get
                val monthName = new DateFormatSymbols().getMonths()(month.toInt-1)

                Html(Messages("awrs.business_details.new_AWBusiness_Yes", day, monthName, year))
            case _ =>  Messages("awrs.business_details.new_AWBusiness_No")
        }
    }
    </div>
}

@ariaDayMonthYear = {
    <span id="newAWBusiness.proposedStartDate-day_reader" class="visuallyhidden" aria-hidden="true">@Messages("awrs.generic.date_day.reader")</span>
    <span id="newAWBusiness.proposedStartDate-month_reader" class="visuallyhidden" aria-hidden="true">@Messages("awrs.generic.date_month.reader")</span>
    <span id="newAWBusiness.proposedStartDate-year_reader" class="visuallyhidden" aria-hidden="true">@Messages("awrs.generic.date_year.reader")</span>
}

@newBusinessRetrievedApplicationSectionForAbnormalScenarios = {
    <div class="form-group">
        @hiddenNewBusinessQuestion
        <legend>@Messages("awrs.business_details.begin_trading")</legend>
        <div id="newAWBusiness.newAWBusiness-yes-content">
            @awrsDateField(
                DateHelperParams(
                    formItem = businessDetailsForm,
                    fieldName = "newAWBusiness.proposedStartDate",
                    hintText = Some(awrsNewBusinessHelpTextHelper(showHint1 = showHint1)),
                    hintTextId  = "newBus-information",
                    ariaDayMonthYear = ariaDayMonthYear,
                    wrapperClass = "panel-indent",
                    ariaLabelledBy = "newAWBusiness.proposedStartDate-legend"
                )
            )
        </div>
    </div>
}

@newBusinessSection = {
    @renderMode match {
        case NewApplicationMode => {
            @newBusinessNewApplicationSection
        }
        case ReturnedApplicationMode => {
            @newBusinessRetrievedApplicationSectionForNormalScenarios
        }
        case ReturnedApplicationEditMode => {
            @newBusinessRetrievedApplicationSectionForAbnormalScenarios
        }
    }
}

@tradingNameLabel = @{
    Messages("awrs.generic.trading_name") + (businessType match {
        // this is left in in case we need to append "(optional)" to the end of this text in the future again
        case _ => ""
    })
}


@businessTypeHeading = {
    @businessType.map {
        case "Partnership" | "LP" | "LLP" => { @Messages("awrs.business_details.heading.partnership", headingPrefix()) }
        case "LLP_GRP" | "LTD_GRP" => { @Messages("awrs.business_details.heading.group", headingPrefix()) }
        case _ => { @Messages("awrs.business_details.heading", headingPrefix()) }
    }
}

@businessNameSectionContent = {
<div id="businessName-content">
    @awrsInputTypeText(
        InputTypeTextParams(
            businessDetailsForm("companyName"),
            inputId = "companyName",
            label = Messages("awrs.generic.business_name"),
            maxLength = AwrsFieldConfig.companyNameLen.toString,
            required = true,
            labelHighlight = true
        )
    )
</div>
}

@businessNameSection = @{
    (isEditMode, AccountUtils.hasAwrs(enrolments), businessType.getOrElse("")) match {
        case (true, true, "LLP_GRP" | "LTD_GRP") => businessNameSectionContent
        case _ =>
    }
}

@includes.awrs_main(title = Messages("awrs.generic.tab.title", businessTypeHeading), userLoggedIn = true){
<div class="grid">
    <div class="grid grid-2-3">
        @backLinkHelper(BackLinkParams(
            sectionName = businessDetailsName
        ))
        @errorSummaryTemplate(businessDetailsForm)
        <header class="page-header">
            <h1 id="additional-information-heading" class="heading-xlarge">@businessTypeHeading</h1>
            @awrsProgressHelper(businessType, businessDetailsName)
        </header>

        @uk.gov.hmrc.play.views.html.helpers.form(action = actionRoute){

            <div class="form-group">
                @businessNameSection
            </div>

            <div class="form-group">
                @awrsInputTypeRadioGroup(
                    InputTypeRadioGroupParams(
                        businessDetailsForm("doYouHaveTradingName"),
                        Seq("Yes" -> Messages("awrs.generic.yes"),
                        "No" -> Messages("awrs.generic.no")),
                        fieldSetClass = "inline",
                        fieldSetAttributes = "id=doYouHaveTradingName_field",
                        legendId = "doYouHaveTradingName-legend",
                        legend = Messages("awrs.generic.do_you_have_trading_name")
                    )
                )
                <div id="doYouHaveTradingName-yes-content">
                    @awrsInputTypeText(
                        InputTypeTextParams(
                            businessDetailsForm("tradingName"),
                            inputId = "tradingName",
                            label = tradingNameLabel,
                            maxLength = AwrsFieldConfig.tradingNameLen.toString,
                            required = true,
                            labelHighlight = true,
                            wrapperClass = "panel-indent"
                        )
                    )
                </div>
            </div>

            <div class="form-group">
                @newBusinessSection
            </div>

            @submitButtonAndNavLinks(SubmitAndNavLinkParams(
                sectionName = businessDetailsName,
                submitText = ctaMessage,
                submitId = "save-and-continue"
            ))
        }
    </div>
</div>
}




